<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube MP3 Downloader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
        let selectedVideos = new Set();

        async function fetchVideos() {
            let videoId = document.getElementById("video_id").value;
            if (!videoId) {
                alert("Please enter a YouTube Video URL.");
                return;
            }
            let response = await fetch("/get_videos", {
                method: "POST",
                body: new URLSearchParams({ video_id: videoId }),
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            });
            let videos = await response.json();
            let list = document.getElementById("video_list");
            list.innerHTML = "";
            if (!videos.length) {
                list.innerHTML = "<li class='list-group-item'>No related videos found.</li>";
                return;
            }
            videos.forEach(video => {
                let row = document.createElement("div");
                row.classList.add("row", "align-items-center", "mb-2");
                let colCheckbox = document.createElement("div");
                colCheckbox.classList.add("col-1");
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = video.url;
                checkbox.classList.add("form-check-input");
                if (selectedVideos.has(video.url)) {
                    checkbox.checked = true;
                }
                checkbox.addEventListener("change", function () {
                    if (this.checked) {
                        selectedVideos.add(this.value);
                    } else {
                        selectedVideos.delete(this.value);
                    }
                });
                colCheckbox.appendChild(checkbox);
                let colTitle = document.createElement("div");
                colTitle.classList.add("col-6");
                let link = document.createElement("a");
                link.href = video.url;
                link.target = "_blank";
                link.textContent = video.title;
                colTitle.appendChild(link);
                let colVideo = document.createElement("div");
                colVideo.classList.add("col-5");
                let iframe = document.createElement("iframe");
                iframe.width = "100%";
                iframe.height = "200";
                iframe.src = `https://www.youtube.com/embed/${new URL(video.url).searchParams.get("v")}`;
                iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                iframe.allowFullscreen = true;
                iframe.onerror = function () {
                    console.error("Error loading video:", video.url);
                    iframe.src = "";
                    iframe.innerHTML = "Video unavailable";
                };
                colVideo.appendChild(iframe);
                row.appendChild(colCheckbox);
                row.appendChild(colTitle);
                row.appendChild(colVideo);
                list.appendChild(row);
            });
        }

        async function downloadSelected() {
            let selected = Array.from(selectedVideos);
            if (selected.length === 0) {
                alert("Please select at least one video.");
                return;
            }
            let response = await fetch("/download", {
                method: "POST",
                body: JSON.stringify({ urls: selected }),
                headers: { "Content-Type": "application/json" }
            });
            if (!response.ok) {
                alert("Error downloading files. Please try again.");
                return;
            }
            let blob = await response.blob();
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "downloads.zip";
            link.click();
        }
    </script>
</head>
<body class="container py-5">
    <h1 class="mb-4">YouTube MP3 Downloader</h1>
    <input type="text" id="video_id" class="form-control mb-3" placeholder="Enter YouTube Video URL">
    <button onclick="fetchVideos()" class="btn btn-primary">Get Related Videos</button>
    <button onclick="downloadSelected()" class="btn btn-success">Download Selected</button>
    <div id="video_list" class="list-group mt-3"></div>

</body>
</html>

